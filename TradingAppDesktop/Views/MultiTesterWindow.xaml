<Window x:Class="TradingAppDesktop.Views.MultiTesterWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    Title="Multi Backtest Harness" Height="800" Width="1100"
    WindowStartupLocation="CenterOwner" FontFamily="Segoe UI">
    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
    <Grid Background="{DynamicResource DarkBackground}" Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <TextBlock Text="MULTI BACKTEST HARNESS" FontSize="18" FontWeight="Bold" Foreground="{DynamicResource AccentColor}" Margin="4"/>
        <Grid Grid.Row="1" Margin="0,10,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="450"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <!-- Left config panel -->
            <Border Grid.Column="0" Background="{DynamicResource CardBackground}" CornerRadius="6" Padding="10" Margin="0,0,8,0">
                <StackPanel>
                    <TextBlock Text="Configuration" FontWeight="Bold" Foreground="{StaticResource AccentColor}" Margin="0,0,0,8"/>
                    <TextBlock Text="Config File (JSON)" Foreground="{DynamicResource PrimaryForeground}"/>
                    <DockPanel>
                        <TextBox x:Name="ConfigPathTextBox" MinWidth="200" Text="multi_backtest.sample.json" Margin="0,5,5,5" x:FieldModifier="protected"/>
                        <Button Content="Browse" Click="BrowseConfig_Click"/>
                    </DockPanel>
                    <TextBlock Text="Database Path" Foreground="{DynamicResource PrimaryForeground}"/>
                    <DockPanel>
                        <TextBox x:Name="DatabasePathTextBox" MinWidth="200" Text="TradingData.db" Margin="0,5,5,5" x:FieldModifier="protected"/>
                        <Button Content="Browse" Click="BrowseDb_Click"/>
                    </DockPanel>
                    <Separator Margin="0,10"/>
                    <Button x:Name="RunButton" Content="Run Backtests" Click="RunButton_Click" Background="{DynamicResource SuccessColor}" x:FieldModifier="protected"/>
                    <Button x:Name="CancelButton" Content="Cancel" Click="CancelButton_Click" Background="{DynamicResource DangerColor}" IsEnabled="False" x:FieldModifier="protected"/>
                    <TextBlock x:Name="StatusText" Text="Idle" Foreground="{DynamicResource WarningColor}" Margin="0,10,0,0" x:FieldModifier="protected"/>
                    <TextBlock Text="Output: results/multi/multi_results.csv" Foreground="{DynamicResource SecondaryForeground}" FontSize="11" Margin="0,4,0,0"/>
                    <Button Content="Open Results Folder" Click="OpenResults_Click" Margin="0,8,0,0"/>
                    <Separator Margin="10,10,10,10"/>
                    <Separator Margin="10,10,10,10"/>
                    <!-- UI-based Config Editor -->
                    <Border Background="{DynamicResource CardBackground}" CornerRadius="4" Padding="8" Margin="0,8,0,0">
                        <StackPanel>
                            <TextBlock Text="Config Editor (UI)" FontWeight="Bold" Foreground="{StaticResource SuccessColor}" FontSize="15" Margin="0,0,0,6"/>

                            <TextBlock Text="Timeframes" FontWeight="SemiBold"/>
                            <TextBlock Text="Strategy" FontWeight="SemiBold" Margin="0,6,0,2"/>
                            <ComboBox x:Name="StrategyCombo" IsEditable="True" Width="200" Margin="0,0,0,8">
                                <ComboBoxItem Content="EmaStochRsi" />
                                <ComboBoxItem Content="EnhancedMACD" />
                                <ComboBoxItem Content="FVG" />
                                <ComboBoxItem Content="IchimokuCloud" />
                                <ComboBoxItem Content="CandleDistributionReversal" />
                                <ComboBoxItem Content="RSIMomentum" />
                                <ComboBoxItem Content="MACDStandard" />
                                <ComboBoxItem Content="RsiDivergence" />
                                <ComboBoxItem Content="FibonacciRetracement" />
                                <ComboBoxItem Content="Aroon" />
                                <ComboBoxItem Content="HullSMA" />
                                <ComboBoxItem Content="SMAExpansion" />
                                <ComboBoxItem Content="BollingerSqueeze" />
                                <ComboBoxItem Content="SupportResistance" />
                                <ComboBoxItem Content="SimpleSMA375" />
                                <ComboBoxItem Content="DEMASuperTrend" />
                                <ComboBoxItem Content="CDVReversalWithEMA" />
                                <ComboBoxItem Content="HarmonicPattern" />
                            </ComboBox>
                            <TextBlock Text="Select one or more timeframes:" FontSize="12" Foreground="Gray" Margin="0,2,0,4"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8" HorizontalAlignment="Left">
                                <StackPanel>
                                    <CheckBox x:Name="Tf5mChk" Content="5m" Checked="TimeframeCheckbox_Checked" Unchecked="TimeframeCheckbox_Unchecked" Margin="0,2"/>
                                    <CheckBox x:Name="Tf15mChk" Content="15m" Checked="TimeframeCheckbox_Checked" Unchecked="TimeframeCheckbox_Unchecked" Margin="0,2"/>
                                    <CheckBox x:Name="Tf1hChk" Content="1h" Checked="TimeframeCheckbox_Checked" Unchecked="TimeframeCheckbox_Unchecked" Margin="0,2"/>
                                </StackPanel>
                                <StackPanel Margin="12,0,0,0">
                                    <CheckBox x:Name="Tf4hChk" Content="4h" Checked="TimeframeCheckbox_Checked" Unchecked="TimeframeCheckbox_Unchecked" Margin="0,2"/>
                                    <CheckBox x:Name="Tf1dChk" Content="1d" Checked="TimeframeCheckbox_Checked" Unchecked="TimeframeCheckbox_Unchecked" Margin="0,2"/>
                                </StackPanel>
                            </StackPanel>

                            <Separator/>
                            <TextBlock Text="Symbol Sets" FontWeight="SemiBold" Margin="0,8,0,4"/>
                            <DockPanel>
                                <TextBox x:Name="SymbolSetNameInput" Width="140" Margin="0,0,6,0" x:FieldModifier="protected"/>
                                <Button Content="Add Set" Click="AddSymbolSet_Click"/>
                                <Button Content="Import CSV" Click="ImportSymbolSetCsv_Click" Margin="6,0,0,0"/>
                            </DockPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,4,0,8">
                                <ListBox x:Name="SymbolSetNamesListBox" Width="220" Height="120" SelectionChanged="SymbolSetNamesListBox_SelectionChanged" x:FieldModifier="protected"/>
                                <StackPanel Margin="6,0,0,0">
                                    <TextBlock Text="Symbols (rows of comma-separated pairs)" FontSize="12"/>
                                    <ItemsControl x:Name="SymbolSetRowsControl" Width="360" Height="100" x:FieldModifier="protected">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <DockPanel Margin="0,2">
                                                    <TextBox Text="{Binding ., Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" AcceptsReturn="False" VerticalAlignment="Center" />
                                                    <Button Content="-" Click="RemoveSymbolRow_Click" Width="28" Margin="6,0,0,0"/>
                                                </DockPanel>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,6,0,0">
                                        <Button Content="Add Row" Click="AddSymbolRow_Click"/>
                                        <Button Content="Save Set" Click="SaveSymbolSet_Click" Margin="6,0,0,0"/>
                                        <Button Content="Remove Set" Click="RemoveSymbolSet_Click" Margin="6,0,0,0"/>
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>

                            <Separator/>
                            <TextBlock Text="Exit Modes (fixed only)" FontWeight="SemiBold" Margin="0,8,0,4"/>
                            <TextBlock Text="Risk Profiles" FontSize="12"/>
                            <DataGrid x:Name="RiskProfilesGrid" AutoGenerateColumns="False" Height="160" CanUserAddRows="False" x:FieldModifier="protected">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*" />
                                    <DataGridTextColumn Header="TP Mult" Binding="{Binding TpMultiplier}" Width="80" />
                                    <DataGridTextColumn Header="Risk Divider (SL)" Binding="{Binding RiskDivider}" Width="100" />
                                </DataGrid.Columns>
                            </DataGrid>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,6,0,0">
                                <Button Content="Add Profile" Click="AddRiskProfile_Click"/>
                                <Button Content="Remove Profile" Click="RemoveRiskProfile_Click" Margin="6,0,0,0"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0" HorizontalAlignment="Right">
                                <Button Content="Reload" Click="ReloadJsonConfig_Click" Background="{DynamicResource AccentColor}" Foreground="{DynamicResource PrimaryForeground}" Margin="0,0,8,0"/>
                                <Button Content="Save" Click="SaveJsonConfig_Click" Background="{DynamicResource WarningColor}" Foreground="Black"/>
                            </StackPanel>
                            <TextBlock x:Name="JsonConfigStatus" Text="" Foreground="{DynamicResource WarningColor}" FontSize="12" Margin="0,6,0,0" x:FieldModifier="protected"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>
            <!-- Right progress panel -->
                    <Border Grid.Column="1" Background="{DynamicResource CardBackground}" CornerRadius="6" Padding="10">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="Progress" Foreground="{DynamicResource AccentColor}" FontWeight="Bold"/>
                    <!-- Moved summary here so it appears to the right of the config panel -->
                    <Border Grid.Row="1" Background="{DynamicResource CardBackground}" CornerRadius="4" Padding="8" Margin="0,8,0,8">
                        <StackPanel>
                            <TextBlock Text="Latest Run Summary" FontWeight="Bold" Foreground="{DynamicResource SuccessColor}" FontSize="15" Margin="0,0,0,6"/>
                            <!-- Use a read-only TextBox so users can select and copy summary text -->
                            <TextBox x:Name="SummaryTextBox" Text="No summary available." Foreground="{DynamicResource SecondaryForeground}" FontSize="13" TextWrapping="Wrap" IsReadOnly="True" BorderThickness="0" Background="Transparent" x:FieldModifier="protected" AcceptsReturn="True" MinHeight="480"/>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,6,0,0">
                                <Button Content="Copy Insights" Click="CopySummary_Click" Background="{DynamicResource AccentColor}" Foreground="{DynamicResource PrimaryForeground}" Padding="6,4"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                        <ItemsControl x:Name="ProgressList" x:FieldModifier="protected">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                             <!-- Use read-only TextBox per progress line so users can select/copy entries -->
                             <!-- Bind OneWay to the item (string). TextBox.Text defaults to TwoWay on some setups and binding to the whole object triggers
                                 "Two way binding requires path or xpath" â€” make it explicitly OneWay to avoid modal binding errors. -->
                             <TextBox Text="{Binding Mode=OneWay}" Foreground="{DynamicResource SecondaryForeground}" FontFamily="Consolas" FontSize="12" Margin="0,2" IsReadOnly="True" BorderThickness="0" Background="Transparent"/>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>
        <Border Grid.Row="2" Background="{DynamicResource CardBackground}" Padding="6" CornerRadius="4">
            <TextBlock Text="Multi Tester runs strategy combinations defined in JSON and appends rows to CSV." Foreground="{DynamicResource SecondaryForeground}" FontSize="12"/>
        </Border>
    </Grid>
    </ScrollViewer>
</Window>