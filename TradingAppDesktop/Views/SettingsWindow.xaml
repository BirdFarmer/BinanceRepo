<Window x:Class="TradingAppDesktop.Views.SettingsWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    Title="Settings" Height="480" Width="680" WindowStartupLocation="CenterOwner" ResizeMode="CanResize" MinWidth="520" MinHeight="360">
    <Border Background="{DynamicResource DarkBackground}" Padding="12">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Text="Settings" Foreground="{DynamicResource AccentColor}" FontSize="16" FontWeight="Bold"/>

            <Grid Grid.Row="1" Margin="0,12,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="180" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- Left nav -->
                <StackPanel Grid.Column="0" Margin="0,0,12,0">
                    <TextBlock Text="Sections" Foreground="{DynamicResource PrimaryForeground}" FontWeight="SemiBold"/>
                    <ListBox x:Name="NavList" Margin="0,6,0,0" Height="280"/>
                </StackPanel>

                <!-- Right content area (scrollable) -->
                <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*" />
                            <ColumnDefinition Width="3*" />
                        </Grid.ColumnDefinitions>

                        <!-- Left column: Theme -->
                        <StackPanel x:Name="ThemePanel" Grid.Column="0" Margin="0,0,12,0">
                            <TextBlock Text="Theme" Foreground="{DynamicResource PrimaryForeground}" FontWeight="SemiBold"/>
                            <ListBox x:Name="ThemeList" Margin="0,6,0,0" Height="220" VerticalContentAlignment="Center"/>
                        </StackPanel>

                        <!-- Right column: Strategies / Harmonic -->
                        <StackPanel x:Name="StrategiesContent" Grid.Column="1">
                            <TextBlock Text="Strategies" Foreground="{DynamicResource PrimaryForeground}" FontWeight="SemiBold"/>
                            <ComboBox x:Name="StrategySelector" Margin="0,6,0,0" Width="320" HorizontalAlignment="Left" SelectionChanged="StrategySelector_SelectionChanged">
                                <ComboBoxItem Content="HarmonicPattern" />
                                <ComboBoxItem Content="BollingerNoSqueeze" />
                                <ComboBoxItem Content="EmaCrossoverVolume" />
                                <ComboBoxItem Content="CandlePatternAnalysis" />
                                    <ComboBoxItem Content="LondonSessionVolumeProfile" />
                                <ComboBoxItem Content="OtherStrategy (disabled)" IsEnabled="False"/>
                                <ComboBoxItem Content="OtherStrategy2 (disabled)" IsEnabled="False"/>
                            </ComboBox>

                            <Border Margin="0,10,0,0" Padding="8" Background="{DynamicResource DarkPanelBackground}" CornerRadius="4">
                                <StackPanel>
                                    <StackPanel x:Name="HarmonicPanel" Visibility="Collapsed">
                                    <TextBlock Text="Harmonic Patterns" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryForeground}"/>
                                    <UniformGrid Columns="2" Margin="0,8,0,0">
                                        <CheckBox x:Name="ChkGartley" Content="Gartley" IsChecked="True" Foreground="{DynamicResource PrimaryForeground}"/>
                                        <CheckBox x:Name="ChkButterfly" Content="Butterfly" IsChecked="True" Foreground="{DynamicResource PrimaryForeground}"/>
                                        <CheckBox x:Name="ChkBat" Content="Bat" IsChecked="True" Foreground="{DynamicResource PrimaryForeground}"/>
                                        <CheckBox x:Name="ChkCrab" Content="Crab" IsChecked="True" Foreground="{DynamicResource PrimaryForeground}"/>
                                        <CheckBox x:Name="ChkCypher" Content="Cypher" IsChecked="True" Foreground="{DynamicResource PrimaryForeground}"/>
                                        <CheckBox x:Name="ChkShark" Content="Shark" IsChecked="True" Foreground="{DynamicResource PrimaryForeground}"/>
                                    </UniformGrid>

                                    <StackPanel Orientation="Horizontal" Margin="0,10,0,0" VerticalAlignment="Center">
                                        <CheckBox x:Name="ChkUseTrendFilter" Content="Use Trend Filter (SMA)" IsChecked="False" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}"/>
                                    </StackPanel>

                                    

                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0" VerticalAlignment="Center">
                                        <TextBlock Text="Validation bars:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource PrimaryForeground}"/>
                                        <TextBox x:Name="TxtValidationBars" Width="64" Text="3"/>
                                    </StackPanel>
                                </StackPanel>
                                
                                <!-- Bollinger settings panel (sibling to HarmonicPanel) -->
                                <StackPanel x:Name="BollingerPanel" Visibility="Collapsed" Margin="0,8,0,0">
                                    <TextBlock Text="Bollinger No-Squeeze Settings" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryForeground}"/>
                                    <UniformGrid Columns="2" Margin="0,8,0,0">
                                        <TextBlock Text="BB Period:" Foreground="{DynamicResource PrimaryForeground}" VerticalAlignment="Center" ToolTip="Bollinger Bands period. Lower = faster response and more entries."/>
                                        <TextBox x:Name="TxtBBPeriod" Width="120" Text="200" ToolTip="Bollinger Bands period. Lower = faster response and more entries."/>

                                        <TextBlock Text="BB StdDev:" Foreground="{DynamicResource PrimaryForeground}" VerticalAlignment="Center" ToolTip="StdDev multiplier for bands. Lower = narrower bands → more cross events."/>
                                        <TextBox x:Name="TxtBBStdDev" Width="120" Text="2.0" ToolTip="StdDev multiplier for bands. Lower = narrower bands → more cross events."/>

                                        <TextBlock Text="Squeeze Min (norm):" Foreground="{DynamicResource PrimaryForeground}" VerticalAlignment="Center" ToolTip="Minimum normalized BB width (bbWidth/ATR) to be considered NOT squeezed. Lower → more entries."/>
                                        <TextBox x:Name="TxtSqueezeMin" Width="120" Text="1.2" ToolTip="Minimum normalized BB width (bbWidth/ATR) to be considered NOT squeezed. Lower → more entries."/>

                                        <TextBlock Text="Volume Mult:" Foreground="{DynamicResource PrimaryForeground}" VerticalAlignment="Center" ToolTip="Volume multiplier vs average. Higher = requires a larger volume candle for entry; lower → more entries."/>
                                        <TextBox x:Name="TxtVolumeMultiplier" Width="120" Text="1.2" ToolTip="Volume multiplier vs average. Higher = requires a larger volume candle for entry; lower → more entries."/>

                                        <TextBlock Text="Avg Vol Period:" Foreground="{DynamicResource PrimaryForeground}" VerticalAlignment="Center" ToolTip="Window (candles) used to compute average volume. Shorter = more sensitive to recent spikes."/>
                                        <TextBox x:Name="TxtAvgVolumePeriod" Width="120" Text="20" ToolTip="Window (candles) used to compute average volume. Shorter = more sensitive to recent spikes."/>

                                        <TextBlock Text="Delayed Re-entry Bars:" Foreground="{DynamicResource PrimaryForeground}" VerticalAlignment="Center" ToolTip="Number of previous candles that must be outside the band before current-candle re-entry. Lower → more entries."/>
                                        <TextBox x:Name="TxtDelayedReentryPrevBars" Width="120" Text="3" ToolTip="Number of previous candles that must be outside the band before current-candle re-entry. Lower → more entries."/>

                                        <TextBlock Text="Trend Gate:" Foreground="{DynamicResource PrimaryForeground}" VerticalAlignment="Center" ToolTip="Trend filter: EMA requires price above EMA; ADX requires ADX≥threshold; RSI requires RSI>50; None disables trend gate."/>
                                        <ComboBox x:Name="CboTrendGate" Width="160" ToolTip="Trend filter: EMA requires price above EMA; ADX requires ADX≥threshold; RSI requires RSI>50; None disables trend gate.">
                                            <ComboBoxItem Content="None" />
                                            <ComboBoxItem Content="EMA" />
                                            <ComboBoxItem Content="ADX" />
                                            <ComboBoxItem Content="RSI" />
                                        </ComboBox>

                                        <TextBlock Text="Trend Period:" Foreground="{DynamicResource PrimaryForeground}" VerticalAlignment="Center" ToolTip="Period used for EMA/ADX/RSI trend calculations. Lower = more responsive."/>
                                        <TextBox x:Name="TxtTrendPeriod" Width="120" Text="50" ToolTip="Period used for EMA/ADX/RSI trend calculations. Lower = more responsive."/>

                                        <TextBlock Text="ADX Threshold:" Foreground="{DynamicResource PrimaryForeground}" VerticalAlignment="Center" ToolTip="Minimum ADX value to consider trend strong when ADX trend gate is selected. Lower → more entries."/>
                                        <TextBox x:Name="TxtAdxThreshold" Width="120" Text="20" ToolTip="Minimum ADX value to consider trend strong when ADX trend gate is selected. Lower → more entries."/>

                                        <TextBlock Text="Debug Mode:" Foreground="{DynamicResource PrimaryForeground}" VerticalAlignment="Center" ToolTip="Enable verbose debug logging showing gate checks and reasons signals were allowed or blocked."/>
                                        <CheckBox x:Name="ChkDebugMode" IsChecked="True" VerticalAlignment="Center" ToolTip="Enable verbose debug logging showing gate checks and reasons signals were allowed or blocked."/>
                                    </UniformGrid>
                                </StackPanel>
                                
                                <!-- EMA Crossover + Volume settings panel -->
                                <StackPanel x:Name="EmaCrossoverPanel" Visibility="Collapsed" Margin="0,8,0,0">
                                    <TextBlock Text="EMA Crossover + Volume Settings" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryForeground}"/>
                                    <UniformGrid Columns="2" Margin="0,8,0,0">
                                        <TextBlock Text="Fast EMA Length:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Shorter fast EMA reacts faster to price changes and will produce earlier cross signals (may increase false signals)." />
                                        <TextBox x:Name="TxtEmaFastLen" Width="120" Text="25" ToolTip="Shorter fast EMA reacts faster to price changes and will produce earlier cross signals (may increase false signals)." />

                                        <TextBlock Text="Slow EMA Length:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Longer slow EMA smooths trend detection; increasing it reduces signal frequency and helps avoid noise." />
                                        <TextBox x:Name="TxtEmaSlowLen" Width="120" Text="50" ToolTip="Longer slow EMA smooths trend detection; increasing it reduces signal frequency and helps avoid noise." />

                                        <TextBlock Text="Volume MA Length:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Number of candles used to compute the average volume baseline. Shorter windows react to recent spikes; longer windows provide a smoother baseline." />
                                        <TextBox x:Name="TxtEmaVolMaLen" Width="120" Text="20" ToolTip="Number of candles used to compute the average volume baseline. Shorter windows react to recent spikes; longer windows provide a smoother baseline." />

                                        <TextBlock Text="Volume Multiplier:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Entry requires current volume > (volume MA × multiplier). Increasing multiplier requires larger volume spikes for entries, reducing false signals during low activity." />
                                        <TextBox x:Name="TxtEmaVolMultiplier" Width="120" Text="1.0" ToolTip="Entry requires current volume > (volume MA × multiplier). Increasing multiplier requires larger volume spikes for entries, reducing false signals during low activity." />
                                    </UniformGrid>
                                </StackPanel>
                                
                                <!-- Candle Pattern Analysis settings panel -->
                                <StackPanel x:Name="CandlePatternPanel" Visibility="Collapsed" Margin="0,8,0,0">
                                    <TextBlock Text="Candle Pattern Analysis Settings" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryForeground}"/>
                                    <UniformGrid Columns="2" Margin="0,8,0,0">
                                        <TextBlock Text="Use Volume Filter:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}"/>
                                        <CheckBox x:Name="ChkCandleUseVolumeFilter" IsChecked="True" VerticalAlignment="Center" ToolTip="Require current candle volume to exceed the Volume MA (see Volume MA Length) for a breakout to count."/>

                                        <TextBlock Text="Use EMA Filter:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}"/>
                                        <CheckBox x:Name="ChkCandleUseEmaFilter" IsChecked="False" VerticalAlignment="Center" ToolTip="Require price direction to agree with EMA(trend). For longs: price &gt; EMA; for shorts: price &lt; EMA (see EMA Length)."/>

                                        <TextBlock Text="Indecisive Threshold:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Body size / range threshold to consider a candle indecisive (e.g. 0.3 = 30%)" />
                                        <TextBox x:Name="TxtCandleIndecThresh" Width="120" Text="0.3" ToolTip="Body / range threshold used to mark a candle indecisive. Lower = stricter (smaller bodies required). Example: 0.3 = 30%"/>

                                        <TextBlock Text="Volume MA Length:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}"/>
                                        <TextBox x:Name="TxtCandleVolMaLen" Width="120" Text="20" ToolTip="Number of candles used to compute the average volume for the volume filter. Shorter windows react faster to recent spikes."/>

                                        <TextBlock Text="EMA Length:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}"/>
                                        <TextBox x:Name="TxtCandleEmaLen" Width="120" Text="50" ToolTip="Period used to compute the EMA for the trend filter. Higher values produce a smoother, stronger trend requirement."/>

                                        <TextBlock Text="Debug Mode:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Enable verbose debug logging for this strategy."/>
                                        <CheckBox x:Name="ChkCandleDebugMode" IsChecked="False" VerticalAlignment="Center" ToolTip="Enable verbose debug logging for this strategy. Shows window, indecisive checks, volume and EMA evaluations."/>
                                    </UniformGrid>
                                </StackPanel>

                                <!-- London Session Volume Profile settings panel -->
                                <StackPanel x:Name="LondonPanel" Visibility="Collapsed" Margin="0,8,0,0">
                                    <TextBlock Text="London Session Volume Profile" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryForeground}"/>
                                    <UniformGrid Columns="2" Margin="0,8,0,0">
                                        <TextBlock Text="Session Start (UTC):" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Session start time in UTC (HH:mm)."/>
                                        <TextBox x:Name="TxtLondonSessionStart" Width="120" Text="08:00" ToolTip="Session start time in UTC (HH:mm)."/>

                                        <TextBlock Text="Session End (UTC):" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Session end time in UTC (HH:mm)."/>
                                        <TextBox x:Name="TxtLondonSessionEnd" Width="120" Text="14:30" ToolTip="Session end time in UTC (HH:mm)."/>

                                        <TextBlock Text="Break Trigger:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Which candle field triggers a breakout check (Close=default, High or Low available)."/>
                                        <ComboBox x:Name="CboLondonBreakCheck" Width="160" ToolTip="Which candle field triggers a breakout check (Close=default, High or Low available).">
                                            <ComboBoxItem Content="Close" />
                                            <ComboBoxItem Content="High" />
                                            <ComboBoxItem Content="Low" />
                                        </ComboBox>

                                        <TextBlock Text="Scan Duration (hrs):" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="How many hours after session end to scan for breaks (0.5 - 12)."/>
                                        <TextBox x:Name="TxtLondonScanDuration" Width="120" Text="4.0" ToolTip="How many hours after session end to scan for breaks (0.5 - 12)."/>

                                        <TextBlock Text="Value Area %:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Value area percentage used to compute VAH/VAL (50-90)."/>
                                        <TextBox x:Name="TxtLondonValueArea" Width="120" Text="70" ToolTip="Value area percentage used to compute VAH/VAL (50-90)."/>

                                        <TextBlock Text="Use Order-Book VAP:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="If enabled, use order-book depth to compute POC/VAH/VAL when depth is available (works in Paper/Real if feed present)."/>
                                        <CheckBox x:Name="ChkLondonUseOrderBook" IsChecked="True" VerticalAlignment="Center" ToolTip="If enabled, use order-book depth to compute POC/VAH/VAL when depth is available (works in Paper/Real if feed present)."/>

                                        <TextBlock Text="Allow Both Sides:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Allow one long and one short per session (true) or only one trade total (false)."/>
                                        <CheckBox x:Name="ChkLondonAllowBothSides" IsChecked="False" VerticalAlignment="Center" ToolTip="Allow one long and one short per session (true) or only one trade total (false)."/>

                                        <TextBlock Text="Watcher expiry (min):" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="How many minutes a watcher remains active after breakout signal (0 = no expiry)."/>
                                        <TextBox x:Name="TxtLondonLimitExpiry" Width="120" Text="60" ToolTip="How many minutes a watcher remains active after breakout signal (0 = no expiry)."/>
                                        <TextBlock Text="Allow entries after scan window:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="When unchecked, entries (including existing watchers) will be prevented after session end + Scan Duration."/>
                                        <CheckBox x:Name="ChkLondonAllowEntriesAfterScanWindow" IsChecked="True" VerticalAlignment="Center" ToolTip="When unchecked, entries (including existing watchers) will be prevented after session end + Scan Duration."/>
                                        <TextBlock Text="Use POC as Stop:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="When enabled, stop is set to session POC and TP computed using the POC Risk Ratio."/>
                                        <CheckBox x:Name="ChkLondonUsePocStop" IsChecked="True" VerticalAlignment="Center" ToolTip="When enabled, stop is set to session POC and TP computed using the POC Risk Ratio."/>
                                        <TextBlock Text="POC Risk Ratio:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="When using POC as stop, multiply the stop->entry distance by this ratio to compute TP (0.5 - 10)." IsEnabled="{Binding IsChecked, ElementName=ChkLondonUsePocStop}"/>
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" IsEnabled="{Binding IsChecked, ElementName=ChkLondonUsePocStop}">
                                            <Slider x:Name="SldLondonPocRiskRatio" Minimum="0.5" Maximum="10" Value="2.0" SmallChange="0.1" LargeChange="0.5" Width="160" ToolTip="POC Risk Ratio: multiplies the stop->entry distance to compute TP." />
                                            <TextBox x:Name="TxtLondonPocRiskRatioValue" Width="64" Margin="8,0,0,0" Text="2.0" ToolTip="Numeric display for POC Risk Ratio."/>
                                        </StackPanel>
                                        <TextBlock Text="Max Entries / Side (per symbol):" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Maximum MARKET entries allowed per side per symbol per session (1 = default)."/>
                                        <TextBox x:Name="TxtLondonMaxEntries" Width="120" Text="1" ToolTip="Maximum MARKET entries allowed per side per symbol per session (1 = default)."/>

                                        <TextBlock Text="Enable London Debug:" VerticalAlignment="Center" Foreground="{DynamicResource PrimaryForeground}" ToolTip="Enable verbose debug logging for the London session strategy."/>
                                        <CheckBox x:Name="ChkLondonEnableDebug" IsChecked="False" VerticalAlignment="Center" ToolTip="Enable verbose debug logging for the London session strategy."/>
                                    </UniformGrid>
                                </StackPanel>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- Placeholder area for other sections -->
                        <TextBlock x:Name="PlaceholderText" Grid.ColumnSpan="2" Visibility="Collapsed" Foreground="{DynamicResource PrimaryForeground}" TextWrapping="Wrap" Margin="0,12,0,0"/>
                    </Grid>
                </ScrollViewer>
            </Grid>

            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                <Button x:Name="CloseButton" Content="Close" Width="80" Margin="8" Click="CloseButton_Click"/>
            </StackPanel>
        </Grid>
    </Border>
</Window>
